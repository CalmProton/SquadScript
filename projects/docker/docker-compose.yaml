services:
  # ---------------------------------------------------------------------------
  # Squad Dedicated Game Server
  # https://hub.docker.com/r/cm2network/squad
  # ---------------------------------------------------------------------------
  squad:
    image: cm2network/squad
    container_name: squadscript-squad
    restart: unless-stopped
    network_mode: host
    volumes:
      - squad-data:/home/steam/squad-dedicated/
    environment:
      - PORT=${SQUAD_PORT:-7787}
      - QUERYPORT=${SQUAD_QUERYPORT:-27165}
      - BEACONPORT=${SQUAD_BEACONPORT:-15000}
      - RCONPORT=${SQUAD_RCONPORT:-21114}
      - RCONPASSWORD=${SQUAD_RCON_PASSWORD:-squadscript-rcon}
      - FIXEDMAXPLAYERS=${SQUAD_MAXPLAYERS:-80}
      - FIXEDMAXTICKRATE=${SQUAD_MAXTICKRATE:-50}
      - RANDOM=NONE
      - MODS=${SQUAD_MODS:-()}
      - SERVER_NAME=${SQUAD_SERVER_NAME:-Squad Dedicated Server}
      - MULTIHOME=${SQUAD_MULTIHOME:-}
    healthcheck:
      test: ["CMD", "sh", "-c", "test -d /home/steam/squad-dedicated/SquadGame"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ---------------------------------------------------------------------------
  # SquadScript Server
  # Core orchestrator: RCON client, log parser, plugin system
  # ---------------------------------------------------------------------------
  squadscript-server:
    build:
      context: ../../
      dockerfile: projects/docker/Dockerfile.server
    container_name: squadscript-server
    restart: unless-stopped
    network_mode: host
    depends_on:
      squad:
        condition: service_started
    volumes:
      - squad-data:/home/steam/squad-dedicated/:ro
    environment:
      - SQUADSCRIPT_CONFIG=/app/config.json
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - SQUADSCRIPT_HEALTH_PORT=${SQUADSCRIPT_HEALTH_PORT:-3002}
      - SQUADSCRIPT_RETRY_MS=${SQUADSCRIPT_RETRY_MS:-5000}
      - SQUADSCRIPT_RCON_HOST=${SQUADSCRIPT_RCON_HOST:-127.0.0.1}
      - SQUADSCRIPT_RCON_PORT=${SQUADSCRIPT_RCON_PORT:-21114}
      - SQUADSCRIPT_RCON_PASSWORD=${SQUAD_RCON_PASSWORD:-squadscript-rcon}
      - SQUADSCRIPT_LOG_DIR=${SQUADSCRIPT_LOG_DIR:-/home/steam/squad-dedicated/SquadGame/Saved/Logs}
    healthcheck:
      test: ["CMD", "bun", "-e", "const start = Number(process.env.SQUADSCRIPT_HEALTH_PORT || '3002'); const check = async () => { for (let offset = 0; offset < 10; offset += 1) { const port = start + offset; try { const res = await fetch('http://127.0.0.1:' + port + '/health'); if (res.ok) { process.exit(0); } } catch {} } process.exit(1); }; check();"]
      interval: 15s
      timeout: 5s
      retries: 8
      start_period: 30s

  # ---------------------------------------------------------------------------
  # SquadScript App
  # Nuxt admin dashboard for server management
  # ---------------------------------------------------------------------------
  squadscript-app:
    build:
      context: ../../
      dockerfile: projects/docker/Dockerfile.app
    container_name: squadscript-app
    restart: unless-stopped
    depends_on:
      squadscript-server:
        condition: service_healthy
    ports:
      - "${APP_PORT:-3000}:3000"
    environment:
      - NUXT_ADMIN_USERNAME=${APP_ADMIN_USERNAME:-admin}
      - NUXT_ADMIN_PASSWORD=${APP_ADMIN_PASSWORD:-admin}
      - NUXT_SESSION_PASSWORD=${APP_SESSION_PASSWORD:-change-me-to-a-random-secret-min-32-chars}
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://127.0.0.1:3000/').then((res)=>process.exit(res.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 45s

volumes:
  squad-data:
    driver: local
